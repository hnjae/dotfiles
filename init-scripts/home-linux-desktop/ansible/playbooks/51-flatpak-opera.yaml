- name: Setup Opera (for Netflix)
  hosts: localhost
  become: false
  vars:
    app_id: com.opera.Opera
    xdg_data_home: "{{ ansible_env.XDG_DATA_HOME | default(ansible_env.HOME + '/.local/share') }}"
    xdg_config_home: "{{ ansible_env.XDG_CONFIG_HOME | default(ansible_env.HOME + '/.config') }}"
    mimeapps_path: "{{ xdg_config_home }}/mimeapps.list"
  tasks:
    - name: Install {{ app_id }} with flatpak
      community.general.flatpak:
        method: user
        state: present
        remote: flathub
        name:
          - "{{ app_id }}"
    - name: Ensure {{ app_id }} is removed from association
      ini_file:
        path: "{{ mimeapps_path }}"
        section: "Removed Associations"
        option: "{{ item }}" # mime
        value: >-
          {{ (





              lookup('ansible.builtin.ini', item,
                     section='Removed Associations',
                     file=mimeapps_path,
                     errors='ignore') | default('', true)
             )
             + app_id + '.desktop;'
             if (app_id + '.desktop;') not in
                (lookup('ansible.builtin.ini', item,
                        section='Removed Associations',
                        file=mimeapps_path,
                        errors='ignore') | default('', true))
             else
                (lookup('ansible.builtin.ini', item,
                        section='Removed Associations',
                        file=mimeapps_path,
                        errors='ignore') | default('', true))
          }}
      loop:
        - application/pdf
        - application/rdf+xml
        - application/rss+xml
        - application/xhtml+xml
        - application/xhtml_xml
        - application/xml
        - image/gif
        - image/jpeg
        - image/png
        - image/webp
        - text/html
        - text/xml
        - x-scheme-handler/http
        - x-scheme-handler/https
        - x-scheme-handler/ipfs
        - x-scheme-handler/ipns
