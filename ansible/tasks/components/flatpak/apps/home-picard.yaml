---
- name: Install and setup Picard
  when: [is_home]
  vars:
    app_id: org.musicbrainz.Picard
  block:
    - name: Install {{ app_id }} with flatpak
      community.general.flatpak:
        method: user
        state: present
        remote: flathub
        name: ['{{ app_id }}']
    - name: Configure {{ app_id }} flatpak overrides
      copy:
        dest: '{{ xdg_data_home }}/flatpak/overrides/{{ app_id }}'
        content: |
          [Context]
          filesystems=/media
        mode: '0644'
        backup: false
    - name: Ensure {{ app_id }} is removed from association
      ini_file:
        path: '{{ mimeapps_path }}'
        section: Removed Associations
        option: '{{ item }}' # mime
        mode: '0644'
        value: >-
          {{ (
              lookup('ansible.builtin.ini', item,
                     section='Removed Associations',
                     file=mimeapps_path,
                     errors='ignore') | default('', true)
             )
             + app_id + '.desktop;'
             if (app_id + '.desktop;') not in
                (lookup('ansible.builtin.ini', item,
                        section='Removed Associations',
                        file=mimeapps_path,
                        errors='ignore') | default('', true))
             else
                (lookup('ansible.builtin.ini', item,
                        section='Removed Associations',
                        file=mimeapps_path,
                        errors='ignore') | default('', true))
          }}
      loop: [video/x-ms-asf, video/x-theora, video/x-wmv, video/ogg]
